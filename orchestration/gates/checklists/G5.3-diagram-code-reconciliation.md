# G5.3 — Diagram-Code Reconciliation Checklist

> **Agent:** diagram-code-reconciliation-auditor
> **Phase:** Production (after G5.2 Design Fidelity, before G5.5 Bibliography)
> **Blocking:** Yes
> **Standard:** `orchestration/standards/diagram-code-contract.md`

## Pre-Conditions

- [ ] Client component exists and contains visualization functions (D1, D2, ...)
- [ ] Every visualization function has a `@diagram-contract` JSDoc block

## Step 1 — Contract Coverage

For each visualization function in the client component:

- [ ] A `@diagram-contract` block exists immediately above the function
- [ ] `@diagram` field matches the function's comment header (e.g., `D1-ocean-wave-anatomy`)
- [ ] `@domain` field is a recognized domain (wave-mechanics, electromagnetism, quantum-mechanics, economics, etc.)
- [ ] At least one `@invariant` is declared

**If any visualization is missing a contract → FAIL (author must add it before audit can proceed)**

## Step 2 — Per-Invariant Verification

For each `@invariant` in each contract, perform **code-level static analysis**:

### Direction Invariants (`PROPAGATION_DIRECTION`, `LONGITUDINAL_MOTION`)

1. Locate the phase/animation formula (typically inside a `draw()` or `useEffect`)
2. Identify the phase update direction (`phase += ...` → positive increment)
3. Check the formula sign:
   - `sin(kx - phase)` with positive phase increment → **+x propagation (rightward)**
   - `sin(kx + phase)` with positive phase increment → **-x propagation (leftward)**
4. Locate any direction arrows (SVG `<line>` + `<polygon>`, or text containing "direction"/"flow")
5. Verify arrow direction matches formula direction
6. **PASS** if consistent, **FAIL** if contradictory

### Label Position Invariants (`LABEL_POSITION_ACCURACY`)

1. Locate label text elements (SVG `<text>`, Canvas `fillText()`)
2. For each labeled feature (crest, trough, node, antinode, compression, rarefaction):
   - Verify the label's x,y coordinates correspond to the physical feature
   - e.g., "crest" label should be near the y-coordinate of `midY - amplitude`
   - e.g., "node" label should be at a point where the wave formula evaluates to zero
3. **PASS** if all labels are correctly positioned, **FAIL** if any mismatch

### Scale/Symmetry Invariants (`AMPLITUDE_SYMMETRY`, `WAVELENGTH_SPAN`)

1. Verify amplitude annotation spans equilibrium → peak (not peak-to-peak)
2. Verify wavelength annotation spans exactly one cycle
3. Check that crest displacement = trough displacement (symmetric about equilibrium)
4. **PASS** if correct, **FAIL** if any scale error

### Superposition Invariants (`SUPERPOSITION_PRINCIPLE`)

1. Verify the sum wave is computed as `y1 + y2` (not `y1 * y2`, `max(y1,y2)`, etc.)
2. Verify individual waves are drawn independently (not affected by each other)
3. **PASS** if principle correctly implemented

### Quantum Invariants (`PROBABILITY_NON_NEGATIVE`, `INTERFERENCE_PATTERN`)

1. Verify probability density uses `|ψ|²` or equivalent non-negative form
2. For double-slit: verify `cos²(...)·sinc²(...)` pattern (both squared → non-negative)
3. For detection: verify single-particle arrival + statistical buildup
4. **PASS** if correct

### Domain-Specific Invariants

Apply any additional invariants declared in the contract using domain knowledge appropriate to the `@domain`.

## Step 3 — Produce Audit Report

Generate `DIAGRAM-CODE-RECONCILIATION.md` with the following structure:

```yaml
---
gate: G5.3
type: Diagram-Code Reconciliation
status: PASS | FAIL
date: YYYY-MM-DD
auditor: diagram-code-reconciliation-auditor
contract_count: N
invariant_count: N
pass_count: N
fail_count: N
---
```

Followed by a per-diagram, per-invariant results table:

| Diagram | Invariant | Status | Detail |
|---|---|---|---|
| D1 | PROPAGATION_DIRECTION | ✅ PASS | sin(kx - phase), phase += 0.012 → +x matches arrow |
| D1 | AMPLITUDE_SYMMETRY | ✅ PASS | midY - amp (crest) / midY + amp (trough) |
| ... | ... | ... | ... |

## Failure Handling

- Any single FAIL → gate status is FAIL
- The audit report must include a **Fix Recommendation** for each failure
- After fixes are applied, the gate must be re-run from scratch (no partial re-audits)

## Relationship to Other Standards

- **Visualization Quality Standard** (`visualization-quality-standard.md`): Ensures visualizations are *well-researched* before rendering
- **Diagram-Code Contract Standard** (`diagram-code-contract.md`): Ensures the *code matches declared diagram intent*
- These are complementary: quality = "did we design the right thing?", reconciliation = "did we build what we designed?"
