[build]
  command = "npm run build:static"
  publish = "out"

[build.environment]
  NODE_VERSION = "18"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# QA Branch Deploy Configuration
# When deploying the 'qa' branch, block all crawlers
[context.qa]
  environment = { NEXT_PUBLIC_IS_QA = "true" }

# Headers for QA branch deploys - block all crawlers and AI bots
[context.qa.processing]
  skip = false

# Note: For qa.esy.com as a separate site, configure headers in that site's settings
# or deploy with NEXT_PUBLIC_IS_QA=true to enable noindex meta tags

# Redirect /essays/visual/* to /essays/* (canonical URLs)
[[redirects]]
  from = "/essays/visual/*"
  to = "/essays/:splat"
  status = 301
  force = true

# Redirect spam traffic from /cities/* to root
[[redirects]]
  from = "/cities/*"
  to = "/"
  status = 301
  force = true

# ─── Essay Path Redirects ──────────────────────────────────────
# Moved /essays/inside-a-black-hole → /essays/science/inside-a-black-hole (Feb 2026)
[[redirects]]
  from = "/essays/inside-a-black-hole/*"
  to = "/essays/science/inside-a-black-hole/:splat"
  status = 301
  force = true

[[redirects]]
  from = "/essays/inside-a-black-hole"
  to = "/essays/science/inside-a-black-hole/"
  status = 301
  force = true

# Proxy /guide section to a separate Netlify site
# This allows the guide to be maintained and deployed independently
# while appearing as part of the main esy.com domain
[[redirects]]
  from = "/guide/*"  # Capture all paths under /guide/
  to = "https://esy-guide.netlify.app/:splat"  # Proxy to guide subdomain, preserving path
  status = 200  # Rewrite (proxy) rather than redirect - URL stays as esy.com/guide/*
  force = true  # Override any existing content at these paths 